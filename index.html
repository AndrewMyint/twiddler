<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="node_modules/moment/moment.js"></script>
    <link rel = "stylesheet" type = "text/css" href = "style.css">
  </head>
  <body>
    <div class = 'header'>
      <h1 id = 'head'>Twiddler</h1>
    </div>
    
    <div class = "head-container">
 
        <div class = "tweetBox"> 
          <img id = "avater" class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png"> 
          <input id = "currentUser" class = "textBox" type="textBox" name="loginName" placeholder="username">
          <button class = "btn" name = "submit" type = "submit">Tweet</button>
          <textarea id = "textArea"  cols = "150" rows= "5"></textarea>

        </div>  
        <div id = "noti"> Back </div>
        <span class = 'notification'></span>
        <div class = "container"></div>
      
    </div>



      <script>
        $(document).ready(function(){

          var $container = $('.container');

        //  var index = streams.home.length - 1;
          var index = 0;
          var oldTweets = streams.home.length;
          var newTweets = 0;

          generateTweet();
          checkNewTweet(oldTweets);

          function  checkNewTweet(oldTweets){
            console.log("old Tweets " + oldTweets);
            var currentTweets = count();
            if(currentTweets > oldTweets){
              newTweets += (currentTweets - oldTweets);
              oldTweets = currentTweets;
            }
            setTimeout(checkNewTweet, 4100, oldTweets);
            $(".notification").text("You have " + newTweets + " new Tweets");
            $(".notification").slideDown(400);
            console.log("currentTweets " + currentTweets);
            console.log("new Tweets " + newTweets);
          }


          function count(){
            return streams.home.length;
          }

          function generateTweet(){
         
              while(index < streams.home.length){

                var tweet = streams.home[index];
                var $username, $userTag, $itemHeaderGroup, $time, $avater, $tweet, $content;
              
                generateTag();
                appendTag(tweet);
                index ++;
              }
               setTimeout(function(){
                generateTweet();
                }, 4000);
            }

          function generateTag(){
            $username = $('<a href="javascript:;" class = "username"> </a>');
            $userTag = $('<span class = "userTag"> </span>')
            $itemHeaderGroup = $('<div class = itemHeaderGroup></div>');
            $time = $('<span id = "time"> </span>');
            $avater = $('<img class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png">')
            $tweet = $('<div class = "tweet"><p> </p></div>');
            $content = $('<div class = "content"> </div>');
          }

          function appendTag(tweet) {
            $username.text(tweet.user);
            $userTag.text('@' + tweet.user);
            $tweet.text(tweet.message);

            $username.appendTo($itemHeaderGroup);
            $userTag.appendTo($itemHeaderGroup);
            $avater.appendTo($content); 
            $itemHeaderGroup.appendTo($content);
            $tweet.appendTo($content);
            $content.prependTo($container);
          }



          $("#textArea").hide();
          $("#noti").hide();
          $(".content").addClass('active');

          $(".textBox").click(function (event) {
            $("#textArea").slideToggle(200);
            event.stopPropagation();
          })

          $(".notification").click(function (event) {
            $(".content").addClass('active'); 
            newTweets = 0;
            $(".notification").slideUp(400);
            $(".tweetBox").fadeIn();
            $("#noti").fadeOut();
          })

          $("button").click(function (event) {
           
            var timeStamp = new Date();
            var time = moment().format("h:mm a - D MMM YYYY");

            var newTweet = $("#textArea").val();
            var currentUser = $("#currentUser").val();
            var $username = $('<a href="javascript:;" class = "username"> </a>');
            var $userTag = $('<span class = "userTag"> </span>');
            var $timesAgo = $('<span id = "timesAgo" </span>');
            var $time = $('<span id = "time"> </span>');
            var $itemHeaderGroup = $('<div class = itemHeaderGroup></div>');
            var $avater = $('<img class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png">')
            var $tweet = $('<div class = "tweet"><p> </p></div>')
            var $content = $('<div class = "content"> </div>');

            $username.text(currentUser);
            $userTag.text('@' + currentUser);
            $timesAgo.text("- " + moment(timeStamp).fromNow());
            $tweet.text(newTweet);
            $time.text(time);
            
            $username.appendTo($itemHeaderGroup)
            $userTag.appendTo($itemHeaderGroup);
           
            $timesAgo.appendTo($itemHeaderGroup);
            $avater.appendTo($content);
            $itemHeaderGroup.appendTo($content); 
            $tweet.appendTo($content); 
            $time.appendTo($content);    

            $content.prependTo($container);

            setInterval(function() {
              $timesAgo.html("- " + moment(timeStamp).fromNow());
            }, 2000);
            //username = $(".username");


           // filterByUserName();
          })
          filterByUserName();

          function filterByUserName(username){
              $("body").on('click', '.username', function (event) {
              //alert($(this).$(".content"));
                $("div.content.active").removeClass('active');
                $(".tweetBox").fadeOut(0);
                $("#noti").fadeIn(0);


                var currentUser = $(this).text();
                var username = $(".username");
                var currentUserArray = username.filter(function (index) {
                  return $(this).text() === currentUser;
                }).each(function (index) {
                  $(this).parents().eq(1).addClass('active');
                })

            })
          }

          $("#noti").click(function (event) {
            $("#noti").fadeOut(0);
            $(".tweetBox").fadeIn(0);
            $(".content").addClass('active');  
          })

      });
       </script>

  </body>
</html>















