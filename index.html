<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="node_modules/moment/moment.js"></script>
    <link rel = "stylesheet" type = "text/css" href = "style.css">
  </head>
  <body>
    <div class = 'header'>
      <h1 id = 'head'>Twiddler</h1>
    </div>
    
    <div class = "head-container">
 
        <div class = "tweetBox"> 
          <img id = "avater" class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png"> 
          <input id = "currentUser" class = "textBox" type="textBox" name="loginName" placeholder="username">
          <button class = "btn" name = "submit" type = "submit">Tweet</button>
          <span class = "message" > Tweeted !!! </span>
          <textarea id = "textArea"  cols = "150" rows= "5"></textarea>

        </div>  
        <div id = "noti"> Back </div>
        <span class = 'notification'></span>
        <div class = "container"></div>
      
    </div>

      <script>
        $(document).ready(function(){
    
          var $container = $('.container');
          var index = 0;
          var oldTweets = streams.home.length;
          var newTweets = 0;

          generateTweets();
          checkNewTweets(oldTweets);
          generateCurrentUserTweet();
          filterByUserName();
          generateEvents();

          function  checkNewTweets(oldTweets){
            var currentTweets = count();
            if(currentTweets > oldTweets){
              newTweets += (currentTweets - oldTweets);
              oldTweets = currentTweets;
            }
            setTimeout(checkNewTweets, 4000, oldTweets);
            $(".notification").text("You have " + newTweets + " new Tweets");
            $(".notification").slideDown(400);
          }

          function count(){
            return streams.home.length;
          }

          function generateTweets(){
            
              while(index < streams.home.length){
                var tag = {};
                var tweet = streams.home[index];
              //  var $username, $userTag, $itemHeaderGroup, $time, $avater, $tweet, $content, $timesAgo;
                var timeStamp = streams.home[index].create_at;
                tag = generateTag(tag, index);
                appendTag(tag, tweet);
                calculateTimesAgo(index);
                index ++;
              }
               setTimeout(function(){
                generateTweets();
                }, 4000);
            }

          function generateTag(tag, index){
            tag.$username = $('<a href="javascript:;" class = "username"> </a>');
            tag.$userTag = $('<span class = "userTag"> </span>')
            tag.$timesAgo = $('<span id = "timesAgo" class =' + index + '> </span>');
            tag.$itemHeaderGroup = $('<div class = itemHeaderGroup></div>');
            tag.$time = $('<span id = "time"> </span>');
            tag.$avater = $('<img class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png">')
            tag.$tweet = $('<div class = "tweet"><p> </p></div>');
            tag.$content = $('<div class = "content"> </div>');
            return tag;
          }

          function appendTag(tag, tweet, timeStamp) {
            tag.$username.text(tweet.user);
            tag.$userTag.text('@' + tweet.user);
            tag.$tweet.text(tweet.message);
            tag.$timesAgo.text("- " + moment(timeStamp).fromNow());
            tag.$time.text(moment(timeStamp).format("h:mm a - D MMM YYYY"));
            tag.$username.appendTo(tag.$itemHeaderGroup);
            tag.$userTag.appendTo(tag.$itemHeaderGroup);
            tag.$timesAgo.appendTo(tag.$itemHeaderGroup);
            tag.$avater.appendTo(tag.$content); 
            tag.$itemHeaderGroup.appendTo(tag.$content);
            tag.$tweet.appendTo(tag.$content);
            tag.$time.appendTo(tag.$content); 
            tag.$content.prependTo($container);
          }

          function calculateTimesAgo(index){
            setInterval(function(index){
                 $("." + index ).html("- " + moment(streams.home[index].created_at).fromNow());
            }, 2000, index)                  
          }

          function generateCurrentUserTweet(){
              $("button").click(function (event) {
             
              var newTweet = $("#textArea").val();
              var currentUser = $("#currentUser").val();

              var tweet = {};
              tweet.user = currentUser;
              tweet.message = newTweet; 
              tweet.created_at = new Date();
              streams.users[currentUser] = [];
              addTweet(tweet);

              $(".message").addClass("active");
              setTimeout(function () {
                $(".message").removeClass("active");
              }, 2000)
            })
          }

          function filterByUserName(username){
              $("body").on('click', '.username', function (event) {
                $("div.content.active").removeClass('active');
                $(".tweetBox").fadeOut(0);
                $("#noti").fadeIn(0);

                var currentUser = $(this).text();
                var username = $(".username");
                var currentUserArray = username.filter(function (index) {
                  return $(this).text() === currentUser;
                }).each(function (index) {
                  $(this).parents().eq(1).addClass('active');
                })

            })
          }
          function generateEvents() {
            $("#textArea").hide();
            $("#noti").hide();
            $(".content").addClass('active');

            $(".textBox").click(function (event) {
              $("#textArea").slideToggle(200);
              event.stopPropagation();
            })

            $(".notification").click(function (event) {
              $(".content").addClass('active'); 
              newTweets = 0;
              $(".notification").slideUp(400);
              $(".tweetBox").fadeIn();
              $("#noti").fadeOut();
            })

            $("#noti").click(function (event) {
              $("#noti").fadeOut(0);
              $(".tweetBox").fadeIn(0);
              $(".content").addClass('active');  
            })
          }
         
      });
       </script>

  </body>
</html>















