<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="node_modules/moment/moment.js"></script>
    <link rel = "stylesheet" type = "text/css" href = "style.css">
  </head>
  <body>
    <div class = 'header'>
      <h1 id = 'head'>Twiddler</h1>
    </div>
    
    <div class = "head-container">
 
        <div class = "tweetBox"> 
          <img id = "avater" class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png"> 
          <input id = "currentUser" class = "textBox" type="text" name="loginName" placeholder="username">
          <button class = "btn" name = "submit" type = "button">Tweet</button>
          <span class = "message" > Tweeted !!!    <img id = 'logo' src="logo.png"></span>
          <textarea id = "textArea"  type= "text" cols = "150" rows= "5"></textarea>

 
        </div> 
        <div class = "notiBar">
          <btn id = "btn1" class = "back btn1" href="javascript:;">back</btn> </span>
          <btn id = "btn1" class = "refresh btn1" href="javascript:;">refresh</btn></span>
          <span id = "n"><a class = 'notification' href="javascript:;"></a></span>
        </div>   
        <div class = "container"></div>
      
    </div>

      <script>
        $(document).ready(function(){
    
          var $container = $('.container');
          var index = 0;
          var oldTweets = streams.home.length;
          var newTweets = 0;
          var bol = false;
          
          generateTweets(index, $container);
          generateEvents();   
          checkNewTweets(oldTweets, newTweets);
          generateCurrentUserTweet();
          filterByUserName();

          function  checkNewTweets(oldTweets){
            var currentTweets =streams.home.length;
            if(currentTweets > oldTweets){
              newTweets += (currentTweets - oldTweets);
              oldTweets = currentTweets;
            }

            setTimeout(checkNewTweets, 4000, oldTweets);
            $(".notification").text("Click here to check " + newTweets + " new Tweets");
            $(".notification").hide();
            $(".notification").slideDown(600);

            $(".notification").click(function () {
              $(".content").addClass('active');
              newTweets = 0;
              $(".notification").fadeOut();
              $(".tweetBox").fadeIn();
              $(".back").fadeOut();
              $(".refresh").fadeOut();
            
            })    
            
          }
      });

          function generateTweets(index, $container){
            
              while(index < streams.home.length){
                var tag = {};
                var tweet = streams.home[index];
              //  var $username, $userTag, $itemHeaderGroup, $time, $avater, $tweet, $content, $timesAgo;
                var timeStamp = streams.home[index].create_at;
                tag = generateTag(tag, index);
                appendTag(tag, tweet, $container);
                calculateTimesAgo(index);
                index ++;
              }
               setTimeout(generateTweets, 4000, index, $container);
            }

          function generateTag(tag, index){
            tag.$username = $('<a href="javascript:;" class = "username"> </a>');
            tag.$userTag = $('<span class = "userTag"> </span>')
            tag.$timesAgo = $('<span id = "timesAgo" class =' + index + '> </span>');
            tag.$itemHeaderGroup = $('<div class = itemHeaderGroup></div>');
            tag.$time = $('<span id = "time"> </span>');
            tag.$avater = $('<img class = "avater" src = "https://abs.twimg.com/sticky/default_profile_images/default_profile_bigger.png">')
            tag.$tweet = $('<div class = "tweet"><p> </p></div>');
            tag.$content = $('<div class = "content"> </div>');
            return tag;
          }

          function appendTag(tag, tweet, $container, timeStamp) {
            tag.$username.text(tweet.user);
            tag.$userTag.text('@' + tweet.user);
            tag.$tweet.text(tweet.message);
            tag.$timesAgo.text("- " + moment(timeStamp).fromNow());
            tag.$time.text(moment(timeStamp).format("h:mm a - D MMM YYYY"));
            tag.$username.appendTo(tag.$itemHeaderGroup);
            tag.$userTag.appendTo(tag.$itemHeaderGroup);
            tag.$timesAgo.appendTo(tag.$itemHeaderGroup);
            tag.$avater.appendTo(tag.$content); 
            tag.$itemHeaderGroup.appendTo(tag.$content);
            tag.$tweet.appendTo(tag.$content);
            tag.$time.appendTo(tag.$content); 
            tag.$content.prependTo($container);
          }

          function calculateTimesAgo(index){
            setInterval(function(index){
                 $("." + index ).html("- " + moment(streams.home[index].created_at).fromNow());
            }, 2000, index)                  
          }

          function generateCurrentUserTweet(){
              $("button").click(function (event) {
              
              var newTweet = $("#textArea").val();
              var currentUser = $("#currentUser").val();

              var tweet = {};
              tweet.user = currentUser;
              tweet.message = newTweet; 
              tweet.created_at = new Date();
              streams.users[currentUser] = [];
              addTweet(tweet);
              document.getElementById("currentUser").value = "";
              document.getElementById("textArea").value = "";
              $(".message").addClass("active");
              setTimeout(function () {
                $(".message").removeClass("active");
              }, 2000)
            })
          }

          function filterByUserName(username){
              $("body").on('click', '.username', function (event) {
                $("div.content.active").removeClass('active');
                $(".tweetBox").fadeOut(0);
                $(".back").fadeIn(0);
                $(".refresh").fadeIn(0);

                var currentUser = $(this).text();
                var username = $(".username");
                var currentUserArray = username.filter(function (index) {
                  return $(this).text() === currentUser;
                }).each(function (index) {
                  $(this).parents().eq(1).addClass('active')
                  //$(this).parents().eq(1).attr('display', 'block').slideDown("400");;
                })
                

              $("body").on('click', '.refresh', function (event) {
               $("div.content.active").removeClass('active');
                $(".tweetBox").fadeOut(0);
                var username = $(".username");
                var currentUserArray = username.filter(function (index) {
                  return $(this).text() === currentUser;
                }).each(function (index) {
                  $(this).parents().eq(1).addClass('active').slideDown(400);
                 // $(this).parents().eq(1).attr('display', 'block').slideDown("400");
                })
              })
            })
          }
          function generateEvents() {
            $("#textArea").hide();
            $(".back").hide();
            $(".refresh").hide();
            $(".notification").hide();
            $(".content").addClass('active');

            $(".textBox").click(function (event) {
              $("#textArea").slideDown(200);
              event.stopPropagation();
            })

            $(".back").click(function (event) {
              $(".back").fadeOut(0);
              $(".tweetBox").fadeIn(0);
              $(".refresh").fadeOut(0);
              $(".content").addClass('active');  
            })

            $('body').click(function (event) {
              $('#textArea').slideUp(200);
            })
            $('#textArea').click(function (event) {
              event.stopPropagation();
            })
          }
          function clearText() {
             document.getElementByClass("textBox").value = "";
             document.getElementById("textArea").value = "";
          }

          
       </script>

  </body>
</html>















